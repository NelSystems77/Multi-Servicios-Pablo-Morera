<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>DEBUG ADMIN</title>
    <style>body{background:#000;color:#0f0;font-family:monospace;padding:20px;}</style>
</head>
<body>
    <h1>MODO DE DIAGN√ìSTICO</h1>
    <div id="status">Cargando autenticaci√≥n...</div>
    <div id="error" style="color:red; margin-top:20px;"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyARYoLaqbQX6uBJc56wELmHWYd1h96ullw",
            authDomain: "pablo-morera-servicios.firebaseapp.com",
            projectId: "pablo-morera-servicios",
            storageBucket: "pablo-morera-servicios.firebasestorage.app",
            messagingSenderId: "1079401266790",
            appId: "1:1079401266790:web:9f63e4b6bc21fd35e277a7",
            measurementId: "G-3933KR8010"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const statusDiv = document.getElementById('status');
        const errorDiv = document.getElementById('error');

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                statusDiv.textContent = "‚ùå ESTADO: No hay usuario logueado.";
                errorDiv.textContent = "Causa: El login no persisti√≥ o no te has logueado. Ve a login.html de nuevo.";
                return;
            }

            statusDiv.textContent = `‚úÖ Usuario detectado: ${user.email} (UID: ${user.uid})`;
            statusDiv.innerHTML += "<br>‚è≥ Consultando base de datos...";

            try {
                const userRef = doc(db, "admins_data", user.uid);
                const userSnap = await getDoc(userRef);

                if (!userSnap.exists()) {
                    statusDiv.innerHTML += "<br>‚ùå ERROR: Documento no encontrado.";
                    errorDiv.innerHTML = "Causa: Tu usuario Auth existe, pero NO tiene ficha en la colecci√≥n 'admins_data' de Firestore.<br>Soluci√≥n: Usa reparar.html de nuevo.";
                    return;
                }

                const userData = userSnap.data();
                statusDiv.innerHTML += `<br>‚úÖ Ficha encontrada. Rol: ${userData.role}`;
                statusDiv.innerHTML += `<br>üìÖ Vencimiento: ${new Date(userData.expiration).toLocaleDateString()}`;

                const now = new Date().getTime();
                if (userData.expiration < now && userData.role !== 'superadmin') {
                    errorDiv.textContent = "‚ùå ERROR: TU CUENTA HA VENCIDO.";
                } else {
                    statusDiv.innerHTML += "<br>üéâ TODO CORRECTO. El sistema deber√≠a dejarte pasar.";
                    errorDiv.style.color = "white";
                    errorDiv.textContent = "Si ves esto, el problema era una redirecci√≥n mal configurada. Vuelve a poner el c√≥digo original de admin.html";
                }

            } catch (e) {
                statusDiv.innerHTML += "<br>‚ùå ERROR CR√çTICO DE CONEXI√ìN.";
                errorDiv.innerHTML = `Mensaje: ${e.message}<br><br><b>¬øPOSIBLE CAUSA?</b> Reglas de Seguridad de Firestore bloqueadas.<br>C√≥digo: permission-denied`;
            }
        });
    </script>
</body>
</html>

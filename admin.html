<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Master - NelSystems</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS GENERALES --- */
        body { background-color: #050505; color: #fff; font-family: 'Roboto', sans-serif; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #000; border-bottom: 2px solid var(--accent-cyan); }
        .logout-btn { background: #ff4757; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s;}
        .logout-btn:hover { background: #ff6b6b; }
        
        /* --- PANEL SUPER ADMIN --- */
        #superAdminPanel { 
            border: 2px solid var(--accent-orange); 
            padding: 20px; 
            margin: 20px auto; 
            border-radius: 8px; 
            background: rgba(255,157,0,0.05); 
            max-width: 800px;
        }
        .super-title { color: var(--accent-orange); font-family: 'Orbitron'; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .admin-input { width: 100%; padding: 10px; margin-bottom: 10px; background: #222; border: 1px solid #555; color: white; border-radius: 4px; }
        
        /* Lista de Admins */
        .user-card { background: #0b0b15; padding: 15px; margin-top: 10px; border: 1px solid #333; display: flex; flex-direction: column; gap: 10px; border-radius: 5px; }
        .time-controls { display: flex; gap: 5px; flex-wrap: wrap; }
        .btn-time { font-size: 0.75rem; padding: 5px 10px; background: #222; color: #ccc; border: 1px solid #444; cursor: pointer; border-radius: 3px; }
        .expired { color: #ff4757; font-weight: bold; } .expire-date { font-weight: bold; color: var(--accent-green); }

        /* --- NUEVOS ESTILOS: FICHA T√âCNICA DE RESERVA --- */
        .booking-card {
            background: #12121a;
            border: 1px solid #333;
            padding: 0; /* Padding interno manejado por hijos */
            margin-bottom: 20px;
            border-left: 8px solid #555; /* Indicador de estado */
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        .booking-header {
            background: #1a1a24;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }
        
        .booking-date { font-family: 'Orbitron'; color: var(--accent-cyan); font-size: 1.1rem; }
        .booking-time { background: #000; padding: 4px 8px; border-radius: 4px; font-weight: bold; color: white; border: 1px solid #444; }

        .booking-body { padding: 15px; }

        .client-info { margin-bottom: 15px; }
        .client-name { font-size: 1.2rem; font-weight: bold; color: white; display: block;}
        .client-service { color: #aaa; font-size: 0.9rem; margin-top: 2px; display: block; text-transform: uppercase; letter-spacing: 1px;}
        .client-phone { color: var(--accent-green); font-size: 0.9rem; text-decoration: none; display: inline-block; margin-top: 5px;}

        /* CAJA DE DETALLES (Lo importante) */
        .detail-box {
            background: #222;
            border: 1px solid #444;
            padding: 12px;
            border-radius: 6px;
            color: #ddd;
            font-size: 0.95rem;
            line-height: 1.5;
            margin: 10px 0;
            white-space: pre-wrap; /* Respeta los enter/saltos de l√≠nea */
        }
        .detail-label { color: var(--accent-orange); font-size: 0.75rem; text-transform: uppercase; font-weight: bold; display: block; margin-bottom: 5px; }

        .booking-footer {
            padding: 10px 15px;
            background: #0e0e12;
            border-top: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; }
        .badge-pending { background: rgba(255, 157, 0, 0.2); color: #ff9d00; border: 1px solid #ff9d00; }
        .badge-confirmed { background: rgba(0, 255, 136, 0.2); color: #00ff88; border: 1px solid #00ff88; }

        .actions { display: flex; gap: 10px; }
        .btn-action { padding: 8px 16px; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; color: #fff; font-size: 0.9rem; transition: 0.2s; }
        .btn-confirm { background: #00b894; color: black; }
        .btn-confirm:hover { background: #00ff88; }
        .btn-delete { background: #d63031; }
        .btn-delete:hover { background: #ff7675; }

        .status-pendiente { border-left-color: #ff9d00; }
        .status-confirmada { border-left-color: #00ff88; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="admin-header">
        <span id="currentUserDisplay" style="color:white; font-size:0.9rem;">Cargando usuario...</span>
        <button class="logout-btn" id="btnLogout">Cerrar Sesi√≥n</button>
    </div>

    <main class="container" style="max-width: 900px; padding: 20px;">
        
        <div id="superAdminPanel" class="hidden">
            <h2 class="super-title">üõ†Ô∏è Gesti√≥n de Accesos</h2>
            <div class="form-group" style="background: rgba(0,0,0,0.3); padding:15px; border-radius:5px;">
                <h3 style="color:white; font-size:1rem; margin-bottom:10px;">Crear Nuevo Admin</h3>
                <input type="email" id="newAdminEmail" class="admin-input" placeholder="Correo">
                <input type="password" id="newAdminPass" class="admin-input" placeholder="Contrase√±a">
                <select id="initialDuration" class="admin-input">
                    <option value="30">1 Mes</option>
                    <option value="90">3 Meses</option>
                    <option value="180">6 Meses</option>
                    <option value="365">1 A√±o</option>
                </select>
                <button class="btn-whatsapp" id="btnCreateAdmin" style="background:var(--accent-orange); padding:10px; width:100%;">Crear Licencia</button>
            </div>
            <div id="adminsList" style="margin-top:20px;"></div>
        </div>

        <header style="margin-bottom: 20px; text-align: center;">
            <h1 style="font-family: 'Orbitron'; font-size: 2rem;">Agenda <span style="color:var(--accent-cyan);">Operativa</span></h1>
        </header>

        <div id="bookingsList">
            <p style="text-align:center; color:#888;">Cargando sistema...</p>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, getDoc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyARYoLaqbQX6uBJc56wELmHWYd1h96ullw",
            authDomain: "pablo-morera-servicios.firebaseapp.com",
            projectId: "pablo-morera-servicios",
            storageBucket: "pablo-morera-servicios.firebasestorage.app",
            messagingSenderId: "1079401266790",
            appId: "1:1079401266790:web:9f63e4b6bc21fd35e277a7",
            measurementId: "G-3933KR8010"
        };

        const app = initializeApp(firebaseConfig); 
        const auth = getAuth(app);
        const db = getFirestore(app);

        // LOGOUT
        document.getElementById('btnLogout').addEventListener('click', async () => {
            try { await signOut(auth); window.location.href = "login.html"; } 
            catch (e) { window.location.href = "login.html"; }
        });

        // SEGURIDAD
        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = "login.html"; return; }
            try {
                const userSnap = await getDoc(doc(db, "admins_data", user.uid));
                if (!userSnap.exists()) { alert("Sin permisos"); await signOut(auth); return; }
                const userData = userSnap.data();
                
                if (userData.expiration < Date.now() && userData.role !== 'superadmin') {
                    alert("LICENCIA VENCIDA"); await signOut(auth); return;
                }
                
                document.getElementById('currentUserDisplay').textContent = userData.email;
                if (userData.role === 'superadmin') {
                    document.getElementById('superAdminPanel').classList.remove('hidden');
                    loadAdminsManagement(); 
                }
                loadReservas();
            } catch (e) { console.error(e); }
        });

        // --- CARGAR RESERVAS CON DETALLE COMPLETO ---
        function loadReservas() {
            const listContainer = document.getElementById('bookingsList');
            const q = query(collection(db, "reservas"), orderBy("fecha"), orderBy("hora"));
            
            onSnapshot(q, (snapshot) => {
                listContainer.innerHTML = "";
                if (snapshot.empty) { 
                    listContainer.innerHTML = "<p style='text-align:center;color:#666'>No hay solicitudes pendientes.</p>"; 
                    return; 
                }
                
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const card = document.createElement("div");
                    card.className = `booking-card status-${data.estado}`;
                    
                    // L√≥gica para obtener el texto del detalle
                    // Buscamos 'detalle', 'notas', 'descripcion' o ponemos un texto por defecto
                    let textoDetalle = "Sin especificaciones.";
                    if (data.detalle && data.detalle.trim() !== "") textoDetalle = data.detalle;
                    else if (data.notas && data.notas.trim() !== "") textoDetalle = data.notas;
                    else if (data.descripcion && data.descripcion.trim() !== "") textoDetalle = data.descripcion;

                    // Tel√©fono (si existe)
                    const telefonoHtml = data.telefono ? `<a href="tel:${data.telefono}" class="client-phone">üìû ${data.telefono}</a>` : '';

                    card.innerHTML = `
                        <div class="booking-header">
                            <span class="booking-date">${data.fecha}</span>
                            <span class="booking-time">${data.hora}</span>
                        </div>
                        
                        <div class="booking-body">
                            <div class="client-info">
                                <span class="client-name">${data.cliente}</span>
                                <span class="client-service">${data.servicio}</span>
                                ${telefonoHtml}
                            </div>

                            <div class="detail-box">
                                <span class="detail-label">Detalle / Instrucciones:</span>
                                ${textoDetalle}
                            </div>
                        </div>

                        <div class="booking-footer">
                            <span class="status-badge ${data.estado === 'pendiente' ? 'badge-pending' : 'badge-confirmed'}">
                                ${data.estado === 'pendiente' ? 'Pendiente Pago' : 'Confirmado'}
                            </span>

                            <div class="actions">
                                ${data.estado === 'pendiente' ? 
                                    `<button class="btn-action btn-confirm" onclick="window.confirmReserva('${docSnap.id}')">Confirmar</button>` : ''
                                }
                                <button class="btn-action btn-delete" onclick="window.deleteReserva('${docSnap.id}')">Eliminar</button>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
            });
        }

        window.confirmReserva = async (id) => { if(confirm("¬øPago recibido?")) await updateDoc(doc(db, "reservas", id), { estado: "confirmada" }); };
        window.deleteReserva = async (id) => { if(confirm("¬øEliminar solicitud?")) await deleteDoc(doc(db, "reservas", id)); };

        // --- CREAR ADMIN & TIEMPOS ---
        const secondaryApp = initializeApp(firebaseConfig, "Secondary");
        const secondaryAuth = getAuth(secondaryApp);
        document.getElementById('btnCreateAdmin').addEventListener('click', async () => {
            /* (L√≥gica de crear admin id√©ntica a la anterior, resumida para no saturar) */
            const email = document.getElementById('newAdminEmail').value;
            const pass = document.getElementById('newAdminPass').value;
            const days = parseInt(document.getElementById('initialDuration').value);
            if(!email || !pass) return alert("Faltan datos");
            try {
                const userCred = await createUserWithEmailAndPassword(secondaryAuth, email, pass);
                const exp = new Date(); exp.setDate(exp.getDate() + days);
                await setDoc(doc(db, "admins_data", userCred.user.uid), { email, role: "admin", expiration: exp.getTime(), createdAt: new Date() });
                alert("Usuario creado"); await signOut(secondaryAuth);
            } catch(e) { alert(e.message); }
        });

        function loadAdminsManagement() {
            const listDiv = document.getElementById('adminsList');
            onSnapshot(collection(db, "admins_data"), (snap) => {
                listDiv.innerHTML = "";
                snap.forEach(d => {
                    const dd = d.data();
                    if(dd.role==='superadmin') return;
                    listDiv.innerHTML += `
                    <div class="user-card">
                        <div style="display:flex;justify-content:space-between"><strong>${dd.email}</strong></div>
                        <div class="time-controls">
                             <button class="btn-time" onclick="window.addTime('${d.id}', 30)">+30d</button>
                             <button class="btn-time" onclick="window.deleteUser('${d.id}')">Borrar</button>
                        </div>
                    </div>`;
                });
            });
        }
        window.addTime = async (uid, d) => { /* L√≥gica de tiempo */ const ref = doc(db,"admins_data",uid); const s = await getDoc(ref); const t = s.data().expiration < Date.now() ? Date.now() : s.data().expiration; await updateDoc(ref, { expiration: t + (d*86400000) }); };
        window.deleteUser = async (uid) => { if(confirm("¬øBorrar?")) await deleteDoc(doc(db,"admins_data",uid)); };

    </script>
</body>
</html>

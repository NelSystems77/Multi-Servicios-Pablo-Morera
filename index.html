<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi Servicios Pablo Morera</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body>

    <header>
        <div class="logo-container">
            <div class="logo-placeholder">üöÄ</div> 
        </div>
        <h1>Multi Servicios Pablo Morera<br><span>??????</span></h1>
        <p class="subtitle">Gesti√≥n de Servicios y Mensajer√≠a</p>
    </header>

    <main class="container">
        <div class="alert-box">
            <h3>‚ö†Ô∏è IMPORTANTE</h3>
            <p>Para garantizarle su servicio se requiere el <strong>50% de anticipo</strong> v√≠a SINPE M√≥vil.</p>
        </div>

        <form id="bookingForm">
            <div class="form-group">
                <label for="serviceType">¬øQu√© servicio necesitas?</label>
                <select id="serviceType" onchange="toggleServiceFields()" required>
                    <option value="" disabled selected>Selecciona una opci√≥n...</option>
                    <option value="tramites">1. Tr√°mites Varios (Hospitales/Cl√≠nicas)</option>
                    <option value="mensajeria">2. Mensajer√≠a y Encomiendas</option>
                    <option value="fila">3. Hacer fila / Guardar espacio</option>
                    <option value="dj">4. Servicio de DJ y Animaci√≥n</option>
                    <option value="otros">5. Otros servicios</option>
                </select>
            </div>

            <div id="fields-tramites" class="service-section hidden">
                <label>Tipo de Tr√°mite:</label>
                <select id="tramiteSubtype" onchange="updateHospitalList()">
                    <option value="Recolecci√≥n de documentos">Recolecci√≥n de documentos</option>
                    <option value="Entrega de referencias">Entrega de referencias</option>
                    <option value="Entrega de recetas">Entrega de recetas</option>
                    <option value="Retiro de medicamentos">Retiro de medicamentos</option>
                    <option value="Sacar citas">Sacar citas en Ebais o cl√≠nicas</option>
                </select>
                
                <label>Seleccione el lugar:</label>
                <select id="hospitalSelect"></select>

                <label style="color:var(--accent-orange); margin-top:10px; display:block;">Hora de la Cita/Tr√°mite:</label>
                <input type="time" id="tramiteHora">
            </div>

            <div id="fields-mensajeria" class="service-section hidden">
                <input type="text" id="msgDesc" placeholder="¬øQu√© desea enviar/recolectar?">
                <input type="text" id="msgRetiro" placeholder="Lugar de retiro">
                <input type="text" id="msgEntrega" placeholder="Lugar de entrega">
                <textarea id="msgDetalles" placeholder="Otros detalles (Contacto, referencias)..."></textarea>
            </div>

            <div id="fields-fila" class="service-section hidden">
                <input type="text" id="filaLugar" placeholder="Lugar del evento/fila">
                <label>Fecha del evento:</label>
                <input type="date" id="filaFecha">
                <label>Hora llegada:</label>
                <input type="time" id="filaHora">
            </div>

            <div id="fields-dj" class="service-section hidden">
                <input type="text" id="djDireccion" placeholder="Direcci√≥n exacta del evento">
                <input type="number" id="djHoras" placeholder="Horas contratadas" min="1">
            </div>

            <div id="fields-otros" class="service-section hidden">
                <textarea id="otrosDesc" placeholder="Describe detalladamente el servicio..."></textarea>
            </div>

            <hr>

            <div class="calendar-section">
                <h2>üìÖ Reserva tu Espacio</h2>
                <p style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">Esta es la hora en que Pablo debe iniciar el servicio.</p>
                <label>Fecha requerida:</label>
                <input type="date" id="reservaFecha" required> 
                <label>Hora de inicio:</label>
                <input type="time" id="reservaHora" required>
                <div id="availabilityMsg" class="availability hidden"></div>
            </div>

            <div class="form-group">
                <label>Tu Nombre:</label>
                <input type="text" id="clientName" required placeholder="Nombre completo">
                <input type="tel" id="clientPhone" placeholder="Tu n√∫mero de tel√©fono (Opcional)" style="margin-top:10px; width:100%; padding:10px; background:#333; border:1px solid #555; color:white;">
            </div>

            <button type="button" id="btnSubmit" class="btn-whatsapp">
                Confirmar y Enviar üì≤
            </button>
        </form>
    </main>

    <footer>
        <p>Multi Servicios Pablo Morera  Dev by NelSystems ¬© 2026</p>
        <a href="https://www.facebook.com/people/Pablo-morera-servicios/100063127666582/?mibextid=wwXIfr&rdid=4gmR7Cqn29eDPJ4V&share_url=https%3A%2F%2Fwww.facebook.com%2Fshare%2F15zyxDWoxP%2F%3Fmibextid%3DwwXIfr" target="_blank" class="fb-link">Facebook Oficial</a>
    </footer>

    <script src="script.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyARYoLaqbQX6uBJc56wELmHWYd1h96ullw",
            authDomain: "pablo-morera-servicios.firebaseapp.com",
            projectId: "pablo-morera-servicios",
            storageBucket: "pablo-morera-servicios.firebasestorage.app",
            messagingSenderId: "1079401266790",
            appId: "1:1079401266790:web:9f63e4b6bc21fd35e277a7",
            measurementId: "G-3933KR8010"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 1. Verificar Disponibilidad
        async function checkAvailability() {
            const fecha = document.getElementById('reservaFecha').value;
            const hora = document.getElementById('reservaHora').value;
            const msgDiv = document.getElementById('availabilityMsg');

            if(!fecha || !hora) return;

            msgDiv.textContent = "Verificando disponibilidad...";
            msgDiv.className = "availability";
            msgDiv.classList.remove('hidden');

            const q = query(
                collection(db, "reservas"),
                where("fecha", "==", fecha),
                where("hora", "==", hora),
                where("estado", "in", ["pendiente", "confirmada"])
            );

            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                msgDiv.textContent = "üö´ Espacio OCUPADO. Por favor elige otro horario.";
                msgDiv.classList.add('busy');
                return false;
            } else {
                msgDiv.textContent = "‚úÖ Espacio DISPONIBLE.";
                msgDiv.classList.add('available');
                return true;
            }
        }

        document.getElementById('reservaFecha').addEventListener('change', checkAvailability);
        document.getElementById('reservaHora').addEventListener('change', checkAvailability);

        // 2. Guardar y Enviar
        document.getElementById('btnSubmit').addEventListener('click', async () => {
            const btn = document.getElementById('btnSubmit');
            const fecha = document.getElementById('reservaFecha').value;
            const hora = document.getElementById('reservaHora').value;
            const cliente = document.getElementById('clientName').value;
            const telefono = document.getElementById('clientPhone').value;
            const servicio = document.getElementById('serviceType').value;

            if(!fecha || !hora || !cliente || !servicio) {
                alert("Por favor completa todos los campos requeridos.");
                return;
            }

            btn.disabled = true;
            btn.textContent = "Procesando...";

            const isFree = await checkAvailability();
            if(!isFree) {
                alert("Lo sentimos, el espacio acaba de ser ocupado.");
                btn.disabled = false;
                btn.textContent = "Confirmar y Enviar üì≤";
                return;
            }

            // --- RECOPILAR DETALLES ( incluye HORA CITA) ---
            let detalleTexto = "";

            switch(servicio) {
                case "tramites":
                    const sub = document.getElementById('tramiteSubtype').value;
                    const hosp = document.getElementById('hospitalSelect').value;
                    const tHora = document.getElementById('tramiteHora').value; // Nueva variable
                    
                    // Formateamos el texto
                    detalleTexto = `Tr√°mite: ${sub}.\nLugar: ${hosp}.`;
                    if(tHora) detalleTexto += `\nHora Cita/Tr√°mite: ${tHora}`;
                    break;

                case "mensajeria":
                    const msgD = document.getElementById('msgDesc').value;
                    const retiro = document.getElementById('msgRetiro').value;
                    const entrega = document.getElementById('msgEntrega').value;
                    const extra = document.getElementById('msgDetalles').value;
                    detalleTexto = `Env√≠o: ${msgD}. \nDe: ${retiro} -> A: ${entrega}. \nNota: ${extra}`;
                    break;

                case "fila":
                    const lugarFila = document.getElementById('filaLugar').value;
                    const fechaFila = document.getElementById('filaFecha').value;
                    const horaFila = document.getElementById('filaHora').value;
                    detalleTexto = `Hacer fila en: ${lugarFila}. \nFecha evento: ${fechaFila} a las ${horaFila}`;
                    break;

                case "dj":
                    const dir = document.getElementById('djDireccion').value;
                    const hrs = document.getElementById('djHoras').value;
                    detalleTexto = `DJ en: ${dir}. \nDuraci√≥n: ${hrs} horas.`;
                    break;

                case "otros":
                    detalleTexto = document.getElementById('otrosDesc').value;
                    break;
            }

            try {
                await addDoc(collection(db, "reservas"), {
                    cliente: cliente,
                    telefono: telefono,
                    servicio: servicio,
                    fecha: fecha,
                    hora: hora,
                    detalle: detalleTexto, 
                    estado: "pendiente",
                    timestamp: new Date()
                });

                window.generateWhatsAppLink(); 

            } catch (e) {
                console.error("Error: ", e);
                alert("Error de conexi√≥n. Intenta de nuevo.");
                btn.disabled = false;
                btn.textContent = "Confirmar y Enviar üì≤";
            }
        });
    </script>
</body>
</html>
